# Mux & Astro and more

# Mux & Astro

> Add high-performance video to your Astro project using Mux

# Mux & Astro

[Mux](https://www.mux.com?utm_campaign=21819274-Astro&utm_source=astro-docs) is a hosted media service that provides video streaming infrastructure and performance analytics for businesses of all scales.

When you use Mux to store and host your video content, you‚Äôll have access to Astro-native video components for [Mux Player](#mux-player), a drop-in component for adding Mux videos in your Astro project, and [Mux Uploader](#mux-uploader) for uploading videos to Mux from your website. These components integrate seamlessly with [Mux Data](https://www.mux.com/docs/guides/data?utm_campaign=21819274-Astro&utm_source=astro-docs) to track your video engagement and performance.

You can also interact with your content through the [Mux Node SDK](#mux-node-sdk).

## Using Mux in Astro

[Section titled ‚ÄúUsing Mux in Astro‚Äù](#using-mux-in-astro)

Mux‚Äôs APIs and web components work in Astro to compress and optimize your videos and streams for the web, adapt the quality of your video to network conditions, and integrate additional features like captions, thumbnails, and analytics. The [Mux Node SDK](https://www.mux.com/docs/integrations/mux-node-sdk?utm_campaign=21819274-Astro&utm_source=astro-docs) supports both Mux Data and the Mux Video API.

## Prerequisites

[Section titled ‚ÄúPrerequisites‚Äù](#prerequisites)

- An existing Astro project. Some features may additionally require an adapter installed for [on-demand server rendering](https://docs.astro.build/en/guides/on-demand-rendering/).
- A Mux account. If you don‚Äôt have an account, you can [sign up with Mux](https://dashboard.mux.com/login?utm_campaign=21819274-Astro&utm_source=astro-docs) using the code `ASTRO` to receive a $50 credit.

## Mux Player

[Section titled ‚ÄúMux Player‚Äù](#mux-player)

In Astro, you can use the full-featured [Mux Player](https://www.mux.com/docs/guides/mux-player-web?utm_campaign=21819274-Astro&utm_source=astro-docs) as a native Astro component for optimized, responsive video playback and live streams.

Mux Player provides a responsive UI based on video player dimensions and stream type, automatic thumbnail previews and poster images, and modern video player capabilities (e.g. fullscreen, picture-in-picture, Chromecast, AirPlay).

 src/components/MyMuxVideoPlayer.astro

```
---import { MuxPlayer } from "@mux/mux-player-astro";---<MuxPlayer  playbackId="DS00Spx1CV902MCtPj5WknGlR102V5HFkDe"  metadata={{ video_title: 'My Astro Video' }}/>
```

Mux Player has built-in support for Mux Data analytics, and will automatically show visitor engagement and video quality metrics in your dashboard once your video has views on your deployed site.

### Installation

[Section titled ‚ÄúInstallation‚Äù](#installation)

Install the Astro version of Mux Player using your preferred package manager:

- [npm](#tab-panel-3064)
- [pnpm](#tab-panel-3065)
- [Yarn](#tab-panel-3066)

   Terminal window

```
npm install @mux/mux-player-astro
```

   Terminal window

```
pnpm add @mux/mux-player-astro
```

   Terminal window

```
yarn add @mux/mux-player-astro
```

Mux Player can also be used in your Astro project as:

- a web component (`<mux-player>` from `@mux/mux-player` )
- a React component (`<MuxPlayer />` from `@mux/mux-player-react`)
- an HTML web embed (`<iframe>`)

### Play a video from Mux

[Section titled ‚ÄúPlay a video from Mux‚Äù](#play-a-video-from-mux)

Import and use the native `<MuxPlayer />` Astro component directly in your `.astro` files like any other Astro component.

You will need the `playbackId` for your asset, which can be found in your Mux dashboard or [retrieved from itsASSET_ID](#retrieve-asset-data).

All other [options to control the Mux web player](https://www.mux.com/docs/guides/player-api-reference/?utm_campaign=21819274-Astro&utm_source=astro-docs) (e.g. hide or display controls, style elements, disable cookies) are optional:

 src/components/StarlightVideo.astro

```
<MuxPlayer  playbackId="FOTbeIxKeMPzyhrob722wytaTGI02Y3zbV00NeFQbTbK00"  metadata={{    video_title: 'Starlight by Astro',  }}  style={{    display: 'block',    aspectRatio: '16/9',    backgroundColor: '#000',    margin: '1rem 0 2rem',  }}  primaryColor="#f2ec3a"  secondaryColor="#0caa09"  accentColor="#6e1e99"  defaultShowRemainingTime={true}/>
```

If your `playbackId` belongs to a live stream instead of a prerecorded video on demand, then the Mux Player will allow you to further customize the player with options such as whether or not to enable [DVR mode](https://www.mux.com/docs/guides/stream-recordings-of-live-streams#dvr-mode-vs-non-dvr-mode?utm_campaign=21819274-Astro&utm_source=astro-docs).

```
<MuxPlayer  playbackId="FOTbeIxKeMPzyhrob722wytaTGI02Y3zbV00NeFQbTbK00"  metadata={{    video_title: 'Starlight stream with Astro',  }}  streamType="live:dvr"/>
```

Every live stream is recorded and saved on Mux as a video asset for future on-demand playback.

## Mux video Element

[Section titled ‚ÄúMux video Element‚Äù](#mux-video-element)

The [Mux video element](https://www.mux.com/docs/guides/play-your-videos#mux-video-element?utm_campaign=21819274-Astro&utm_source=astro-docs) is a drop-in replacement for the HTML5 `<video>` element that provides browser support for HLS playback, and has Mux Data automatically configured to show visitor and performance metrics. Use this when you do not need or want all the features of [Mux Player](#mux-player).

To use the `<mux-video>` web component, first install `mux-video` using your preferred package manager:

- [npm](#tab-panel-3067)
- [pnpm](#tab-panel-3068)
- [Yarn](#tab-panel-3069)

   Terminal window

```
npm install @mux/mux-video
```

   Terminal window

```
pnpm add @mux/mux-video
```

   Terminal window

```
yarn add @mux/mux-video
```

Then, you can import and render the web component in a `<script>` tag in your `.astro` file.

You will need the `playback-id` for your video asset, which can be found in your Mux dashboard or [retrieved from itsASSET_ID](#retrieve-asset-data).

All attributes for the HTML 5 `<video>` element (e.g. `poster`, `controls`, `muted`) are available, as well as additional Mux video player controls (e.g. to provide metadata, control the resolution, disable cookies):

 src/components/StarlightVideo.astro

```
<script>import '@mux/mux-video'</script>
<mux-video  playback-id="FOTbeIxKeMPzyhrob722wytaTGI02Y3zbV00NeFQbTbK00"  metadata-video-title="Starlight by Astro"  controls  disable-tracking></mux-video>
```

## Mux Node SDK

[Section titled ‚ÄúMux Node SDK‚Äù](#mux-node-sdk)

The [Mux Node SDK](https://www.mux.com/docs/integrations/mux-node-sdk?utm_campaign=21819274-Astro&utm_source=astro-docs) provides authenticated access to the Mux REST API from server-side TypeScript or JavaScript. This allows you to interact with your Mux assets and data in the component script of your `.astro` files.

While the Mux Player and Mux Video components do not require authentication and can play any publicly accessible video given its `playbackId`, connecting to your hosted Mux data via the Node SDK requires [a Mux API access token](#mux-environment-api-access).

### Installation

[Section titled ‚ÄúInstallation‚Äù](#installation-1)

Install the Mux Node SDK using your preferred package manager:

- [npm](#tab-panel-3070)
- [pnpm](#tab-panel-3071)
- [Yarn](#tab-panel-3072)

   Terminal window

```
npm install @mux/mux-node
```

   Terminal window

```
pnpm add @mux/mux-node
```

   Terminal window

```
yarn add @mux/mux-node
```

### Mux Environment API access

[Section titled ‚ÄúMux Environment API access‚Äù](#mux-environment-api-access)

API tokens are tied to a specific Mux Environment, which is essentially a container for your videos and related data. When you sign up for Mux, an Environment is created for you automatically. If you‚Äôve created additional Environments, make sure you select the correct one before generating your tokens. From there, you can [get your ID and SECRET tokens](https://www.mux.com/docs/core/stream-video-files#1-get-an-api-access-token) and provide them to the Node SDK. These tokens can be passed into your Astro components as environment variables stored in a `.env` file.

This will allow you to create an instance of the Mux Node SDK for retrieving information about your videos, creating new assets, accessing metrics and real-time performance, and more:

 src/components/StarlightVideo.astro

```
---import Mux from "@mux/mux-node";
const mux = new Mux ({  tokenId: import.meta.env.MUX_TOKEN_ID,  tokenSecret: import.meta.env.MUX_TOKEN_SECRET,})---
```

   Read more about using [environment variables](https://docs.astro.build/en/guides/environment-variables/) in your Astro project, including creating a [type-safe schema](https://docs.astro.build/en/guides/environment-variables/#type-safe-environment-variables) for your Mux credentials.

### Retrieve asset data

[Section titled ‚ÄúRetrieve asset data‚Äù](#retrieve-asset-data)

To fetch information about your video to use in your Astro project, provide the video‚Äôs `ASSET_ID` (available in the Mux dashboard) to the `retrieve()` helper function. This will allow you to pass values to both your Mux components and your HTML template, such as the video‚Äôs title or duration:

```
---import Mux from "@mux/mux-node";import { MuxPlayer } from "@mux/mux-player-astro";
const mux = new Mux({  tokenId: import.meta.env.MUX_TOKEN_ID,  tokenSecret: import.meta.env.MUX_TOKEN_SECRET,})
const ASSET_ID = "E01irAaN8c6dk1010153uC2mzst7RVbAdJJWtHECAHFvDo";const asset = await mux.video.assets.retrieve(ASSET_ID);
const playbackId = asset.playback_ids?.find((id)=> id.policy=== "public")?.id;const videoTitle = asset?.meta?.title;const createdAt = Number(asset?.created_at);const duration = Number(asset?.duration)
const date = new Date(createdAt * 1000).toDateString()const time = new Date(Math.round(duration) * 1000).toISOString().substring(14, 19)---<h1>My Video Page</h1><p>Title: {videoTitle}</p><p>Upload Date: {date}</p><p>Length: {time}</p>
<MuxPlayer  playbackId={playbackId}  metadata={{video_title: videoTitle}}/>
```

See all asset properties in the [Mux Asset API documentation](https://www.mux.com/docs/api-reference/video/assets?utm_campaign=21819274-Astro&utm_source=astro-docs).

## Mux Uploader

[Section titled ‚ÄúMux Uploader‚Äù](#mux-uploader)

[Mux Uploader](https://www.mux.com/docs/guides/mux-uploader?utm_campaign=21819274-Astro&utm_source=astro-docs) is a fully-functional, customizable video upload UI for your Astro website. The native Astro `<MuxUpload />` component allows you to build video upload functionality into your web app.

Mux Uploader supports both manual file selection and drag and drop for file uploads, optional pausing and resuming of uploads, and more.

### Installation

[Section titled ‚ÄúInstallation‚Äù](#installation-2)

Install the Astro version of Mux Uploader using your preferred package manager:

- [npm](#tab-panel-3073)
- [pnpm](#tab-panel-3074)
- [Yarn](#tab-panel-3075)

   Terminal window

```
npm install @mux/mux-uploader-astro
```

   Terminal window

```
pnpm add @mux/mux-uploader-astro
```

   Terminal window

```
yarn add @mux/mux-uploader-astro
```

### Upload a video to Mux

[Section titled ‚ÄúUpload a video to Mux‚Äù](#upload-a-video-to-mux)

Before uploading a video, make sure you have your [Mux API access tokens](#mux-environment-api-access) configured. With those in place, you can use the `create()` function from the Mux Node SDK to start a new video upload:

```
---import Layout from '../../layouts/Layout.astro';import Mux from "@mux/mux-node";import { MuxUploader } from "@mux/mux-uploader-astro";
const mux = new Mux({  tokenId: import.meta.env.MUX_TOKEN_ID,  tokenSecret: import.meta.env.MUX_TOKEN_SECRET});
const upload = await mux.video.uploads.create({  new_asset_settings: {    playback_policy: ['public'],    video_quality: 'basic'  },  cors_origin: '*',});---<Layout title="Upload a video to Mux">  <MuxUploader endpoint={upload.url} /></Layout>
```

### Customize the uploader

[Section titled ‚ÄúCustomize the uploader‚Äù](#customize-the-uploader)

You can customize the functionality and appearance of the `<MuxUploader />` with additional component attributes. In addition to styling your element, this allows you to control options such as the ability to pause a download or set a maximum file size.

```
---import { MuxUploader } from '@mux/mux-uploader-astro';---
<MuxUploader  endpoint="https://my-authenticated-url/storage?your-url-params"  pausable  maxFileSize={1000000000}  chunkSize={8192}  style={{    '--progress-bar-fill-color': '#7e22ce',    '--button-background-color': '#f0f0f0',  }}/>
```

See the [Mux Uploader customization guide](https://www.mux.com/docs/guides/uploader-web-customize-look-and-feel?utm_campaign=21819274-Astro&utm_source=astro-docs) for more options.

### Event handling for uploads

[Section titled ‚ÄúEvent handling for uploads‚Äù](#event-handling-for-uploads)

Mux Uploader provides a feature-rich, dynamic UI that changes based on the current state of your media upload. The uploader‚Äôs behavior responds to both user-driven events (e.g. selecting a file, retrying after an error) and state-driven events (e.g. upload in-progress, upload successfully completed).

You can listen for these events and handle them in your Astro component with [client-side scripts](https://docs.astro.build/en/guides/client-side-scripts/). A `MuxUploaderElement` type is also available.

```
---import { MuxUploader } from '@mux/mux-uploader-astro';---
<MuxUploader  id="my-uploader"  endpoint="https://my-authenticated-url/storage?your-url-params"  pausable/>
<script>  import type { MuxUploaderElement } from '@mux/mux-uploader-astro';
  const uploader = document.getElementById('my-uploader') as MuxUploaderElement;
  uploader.addEventListener('uploadstart', (event) => {    console.log('Upload started!', event.detail);  });
  uploader.addEventListener('success', (event) => {    console.log('Upload successful!', event.detail);  });
  uploader.addEventListener('uploaderror', (event) => {    console.error('Upload error!', event.detail);  });
  uploader.addEventListener('progress', (event) => {    console.log('Upload progress: ', event.detail);  });</script>
```

## Official Resources

[Section titled ‚ÄúOfficial Resources‚Äù](#official-resources)

For the full API and webhook reference, usage guides, and information about additional topics, such as integrating with a CMS, building custom video workflows, and more, please see:

- [The official Mux documentation for Astro](https://www.mux.com/docs/integrations/astro?utm_campaign=21819274-Astro&utm_source=astro-docs)
- [@mux/mux-player-astroAPI reference](https://github.com/muxinc/elements/blob/main/packages/mux-player-astro/README.md)
- [@mux/mux-uploader-astroAPI reference](https://github.com/muxinc/elements/blob/main/packages/mux-uploader-astro/REFERENCE.md)
- [Building a video uploader with Mux and Astro (YouTube)](https://www.youtube.com/watch?v=aaL1k5FsWfE)
- [Astro uploader and player code example (GitHub)](https://github.com/muxinc/examples/tree/main/astro-uploader-and-player)

## More hosted media guides

- ![](https://docs.astro.build/logos/cloudinary.svg)
  ### Cloudinary
- ![](https://docs.astro.build/logos/mux.svg)
  ### Mux

   Recipes     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# Image and video hosting with Astro

> How to use a hosted media service to add images and videos to Astro

# Image and video hosting with Astro

Follow one of our guides to integrate images and videos from a hosted media service.

## Hosted Media Guides

[Section titled ‚ÄúHosted Media Guides‚Äù](#hosted-media-guides)

- ![](https://docs.astro.build/logos/cloudinary.svg)
  ### Cloudinary
- ![](https://docs.astro.build/logos/mux.svg)
  ### Mux

## Why use hosted media?

[Section titled ‚ÄúWhy use hosted media?‚Äù](#why-use-hosted-media)

Hosted media helps individuals, teams, and organizations store, manage, optimize, and deliver their image and video assets with dedicated APIs from a central location.

This centralization can be useful, particularly when using a single source of truth for your assets between multiple web or mobile properties. This is important if you‚Äôre part of an organization that requires multiple teams to use the same assets, or are integrating into other content systems like a PIM (Product Information Manager) to connect your assets to products.

Image hosting services can transform and optimize your images, automatically delivering optimized versions for your visitors. These [remote images](https://docs.astro.build/en/guides/images/#remote-images) can be used in Astro‚Äôs built-in `<Image />` and `<Picture />` components, and are available to all file types in your project, including Markdown, MDX, and UI Framework components.

Video hosting services like [Mux](https://docs.astro.build/en/guides/media/mux/) can provide performant on-demand and live-streaming video delivery along with customizable video players, giving significant reliability and scaling benefits over handling local content. They will handle video transcoding, compression, and transformation to provide a smooth user experience. A platform like Mux may also include data analysis to help you understand your user engagement.

## Which hosted media systems work well with Astro?

[Section titled ‚ÄúWhich hosted media systems work well with Astro?‚Äù](#which-hosted-media-systems-work-well-with-astro)

Much like when using a CMS, you‚Äôll want to use hosted services that allow you to fetch and interact with your assets via an API or SDK. Some services may additionally include Astro-native components for displaying your images or videos.

## Can I use Astro without a hosted media system?

[Section titled ‚ÄúCan I use Astro without a hosted media system?‚Äù](#can-i-use-astro-without-a-hosted-media-system)

Yes! Astro provides built-in ways to [store images](https://docs.astro.build/en/guides/images/#where-to-store-images), including support for referencing remote images.

However, there is no native video support in Astro, and we recommend choosing a service like [Mux](https://docs.astro.build/en/guides/media/mux/) to handle the demands of optimizing and streaming video content.

 Recipes     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# Middleware

> Learn how to use middleware in Astro.

# Middleware

**Middleware** allows you to intercept requests and responses and inject behaviors dynamically every time a page or endpoint is about to be rendered. This rendering occurs at build time for all prerendered pages, but occurs when the route is requested for pages rendered on demand, making [additional SSR features like cookies and headers](https://docs.astro.build/en/guides/on-demand-rendering/#on-demand-rendering-features) available.

Middleware also allows you to set and share request-specific information across endpoints and pages by mutating a `locals` object that is available in all Astro components and API endpoints. This object is available even when this middleware runs at build time.

## Basic Usage

[Section titled ‚ÄúBasic Usage‚Äù](#basic-usage)

1. Create `src/middleware.js|ts` (Alternatively, you can create `src/middleware/index.js|ts`.)
2. Inside this file, export an [onRequest()](https://docs.astro.build/en/reference/modules/astro-middleware/#onrequest) function that can be passed a [contextobject](#the-context-object) and `next()` function. This must not be a default export.
   src/middleware.js
  ```
  export function onRequest (context, next) {    // intercept data from a request    // optionally, modify the properties in `locals`    context.locals.title = "New title";
      // return a Response or the result of calling `next()`    return next();};
  ```
3. Inside any `.astro` file, access response data using `Astro.locals`.
   src/components/Component.astro
  ```
  ---const data = Astro.locals;---<h1>{data.title}</h1><p>This {data.property} is from middleware.</p>
  ```

### Thecontextobject

[Section titled ‚ÄúThe context object‚Äù](#the-context-object)

The [context](https://docs.astro.build/en/reference/api-reference/) object includes information to be made available to other middleware, API routes and `.astro` routes during the rendering process.

This is an optional argument passed to `onRequest()` that may contain the `locals` object as well as any additional properties to be shared during rendering. For example, the `context` object may include cookies used in authentication.

### Storing data incontext.locals

[Section titled ‚ÄúStoring data in context.locals‚Äù](#storing-data-in-contextlocals)

`context.locals` is an object that can be manipulated inside the middleware.

This `locals` object is forwarded across the request handling process and is available as a property to [APIContext](https://docs.astro.build/en/reference/api-reference/#locals) and [AstroGlobal](https://docs.astro.build/en/reference/api-reference/#locals). This allows data to be shared between middlewares, API routes, and `.astro` pages. This is useful for storing request-specific data, such as user data, across the rendering step.

You can store any type of data inside `locals`: strings, numbers, and even complex data types such as functions and maps.

 src/middleware.js

```
export function onRequest (context, next) {    // intercept data from a request    // optionally, modify the properties in `locals`    context.locals.user.name = "John Wick";    context.locals.welcomeTitle = () => {        return "Welcome back " + locals.user.name;    };
    // return a Response or the result of calling `next()`    return next();};
```

Then you can use this information inside any `.astro` file with `Astro.locals`.

 src/pages/orders.astro

```
---const title = Astro.locals.welcomeTitle();const orders = Array.from(Astro.locals.orders.entries());const data = Astro.locals;---<h1>{title}</h1><p>This {data.property} is from middleware.</p><ul>    {orders.map(order => {        return <li>{/* do something with each order */}</li>;    })}</ul>
```

`locals` is an object that lives and dies within a single Astro route; when your route page is rendered, `locals` won‚Äôt exist anymore and a new one will be created. Information that needs to persist across multiple page requests must be stored elsewhere.

## Example: redacting sensitive information

[Section titled ‚ÄúExample: redacting sensitive information‚Äù](#example-redacting-sensitive-information)

The example below uses middleware to replace ‚ÄúPRIVATE INFO‚Äù with the word ‚ÄúREDACTED‚Äù to allow you to render modified HTML on your page:

 src/middleware.js

```
export const onRequest = async (context, next) => {    const response = await next();    const html = await response.text();    const redactedHtml = html.replaceAll("PRIVATE INFO", "REDACTED");
    return new Response(redactedHtml, {        status: 200,        headers: response.headers    });};
```

## Middleware types

[Section titled ‚ÄúMiddleware types‚Äù](#middleware-types)

You can import and use the utility function [defineMiddleware()](https://docs.astro.build/en/reference/modules/astro-middleware/#definemiddleware) to take advantage of type safety:

 src/middleware.ts

```
import { defineMiddleware } from "astro:middleware";
// `context` and `next` are automatically typedexport const onRequest = defineMiddleware((context, next) => {
});
```

Instead, if you‚Äôre using JsDoc to take advantage of type safety, you can use `MiddlewareHandler`:

 src/middleware.js

```
/** * @type {import("astro").MiddlewareHandler} */// `context` and `next` are automatically typedexport const onRequest = (context, next) => {
};
```

To type the information inside `Astro.locals`, which gives you autocompletion inside `.astro` files and middleware code, [extend the global types](https://docs.astro.build/en/guides/typescript/#extending-global-types) by declaring a global namespace in the `env.d.ts` file:

 src/env.d.ts

```
type User = {  id: number;  name: string;};
declare namespace App {  interface Locals {    user: User;    welcomeTitle: () => string;    orders: Map<string, object>;    session: import("./lib/server/session").Session | null;  }}
```

Then, inside the middleware file, you can take advantage of autocompletion and type safety.

## Chaining middleware

[Section titled ‚ÄúChaining middleware‚Äù](#chaining-middleware)

Multiple middlewares can be joined in a specified order using [sequence()](https://docs.astro.build/en/reference/modules/astro-middleware/#sequence):

 src/middleware.js

```
import { sequence } from "astro:middleware";
async function validation(_, next) {    console.log("validation request");    const response = await next();    console.log("validation response");    return response;}
async function auth(_, next) {    console.log("auth request");    const response = await next();    console.log("auth response");    return response;}
async function greeting(_, next) {    console.log("greeting request");    const response = await next();    console.log("greeting response");    return response;}
export const onRequest = sequence(validation, auth, greeting);
```

This will result in the following console order:

 Terminal window

```
validation requestauth requestgreeting requestgreeting responseauth responsevalidation response
```

## Rewriting

[Section titled ‚ÄúRewriting‚Äù](#rewriting)

**Added in:** `astro@4.13.0`

The `APIContext` exposes a method called [rewrite()](https://docs.astro.build/en/reference/api-reference/#rewrite) which works the same way as [Astro.rewrite](https://docs.astro.build/en/guides/routing/#rewrites).

Use `context.rewrite()` inside middleware to display a different page‚Äôs content without [redirecting](https://docs.astro.build/en/guides/routing/#dynamic-redirects) your visitor to a new page. This will trigger a new rendering phase, causing any middleware to be re-executed.

 src/middleware.js

```
import { isLoggedIn } from "~/auth.js"export function onRequest (context, next) {  if (!isLoggedIn(context)) {    // If the user is not logged in, update the Request to render the `/login` route and    // add header to indicate where the user should be sent after a successful login.    // Re-execute middleware.    return context.rewrite(new Request("/login", {      headers: {        "x-redirect-to": context.url.pathname      }    }));  }
  return next();};
```

You can also pass the `next()` function an optional URL path parameter to rewrite the current `Request` without retriggering a new rendering phase. The location of the rewrite path can be provided as a string, URL, or `Request`:

 src/middleware.js

```
import { isLoggedIn } from "~/auth.js"export function onRequest (context, next) {  if (!isLoggedIn(context)) {    // If the user is not logged in, update the Request to render the `/login` route and    // add header to indicate where the user should be sent after a successful login.    // Return a new `context` to any following middlewares.    return next(new Request("/login", {      headers: {        "x-redirect-to": context.url.pathname      }    }));  }
  return next();};
```

The `next()` function accepts the same payload of [theAstro.rewrite()function](https://docs.astro.build/en/reference/api-reference/#rewrite). The location of the rewrite path can be provided as a string, URL, or `Request`.

When you have multiple middleware functions chained via [sequence()](#chaining-middleware), submitting a path to `next()` will rewrite the `Request` in place and the middleware will not execute again. The next middleware function in the chain will receive the new `Request` with its updated `context`.

Calling `next()` with this signature will create a new `Request` object using the old `ctx.request`. This means that trying to consume `Request.body`, either before or after this rewrite, will throw a runtime error. This error is often raised with [Astro Actions that use HTML forms](https://docs.astro.build/en/guides/actions/#call-actions-from-an-html-form-action). In these cases, we recommend handling rewrites from your Astro templates using `Astro.rewrite()` instead of using middleware.

 src/middleware.js

```
// Current URL is https://example.com/blog
// First middleware functionasync function first(context, next) {  console.log(context.url.pathname) // this will log "/blog"  // Rewrite to a new route, the homepage  // Return updated `context` which is passed to next function  return next("/")}
// Current URL is still https://example.com/blog
// Second middleware functionasync function second(context, next) {  // Receives updated `context`  console.log(context.url.pathname) // this will log  "/"  return next()}
export const onRequest = sequence(first, second);
```

## Error pages

[Section titled ‚ÄúError pages‚Äù](#error-pages)

Middleware will attempt to run for all on-demand rendered pages, even when a matching route cannot be found. This includes Astro‚Äôs default (blank) 404 page and any custom 404 pages. However, it is up to the [adapter](https://docs.astro.build/en/guides/on-demand-rendering/) to decide whether that code runs. Some adapters may serve a platform-specific error page instead.

Middleware will also attempt to run before serving a 500 error page, including a custom 500 page, unless the server error occurred in the execution of the middleware itself. If your middleware does not run successfully, then you will not have access to `Astro.locals` to render your 500 page.

 Learn     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# Migrating from Create React App (CRA)

> Tips for migrating an existing Create React App project to Astro

# Migrating from Create React App (CRA)

Astro‚Äôs [React integration](https://docs.astro.build/en/guides/integrations-guide/react/) provides support for [using React components inside Astro components](https://docs.astro.build/en/guides/framework-components/), including entire React apps like Create React App (CRA)!

 src/pages/index.astro

```
---// Import your root App componentimport App from '../cra-project/App.jsx';---<App client:load />
```

   See how to [Build a Single Page Application (SPA) with Astro](https://logsnag.com/blog/react-spa-with-astro) External

 using React Router.

Many apps will ‚Äújust work‚Äù as full React apps when you add them directly to your Astro project with the React integration installed. This is a great way to get your project up and running immediately and keep your app functional while you migrate to Astro.

Over time, you can convert your structure piece-by-piece to a combination of `.astro` and `.jsx` components. You will probably discover you need fewer React components than you think!

Here are some key concepts and migration strategies to help you get started. Use the rest of our docs and our [Discord community](https://astro.build/chat) to keep going!

## Key Similarities between CRA and Astro

[Section titled ‚ÄúKey Similarities between CRA and Astro‚Äù](#key-similarities-between-cra-and-astro)

- The [syntax of.astrofiles is similar to JSX](https://docs.astro.build/en/reference/astro-syntax/#differences-between-astro-and-jsx). Writing Astro should feel familiar.
- Astro uses file-based routing, and [allows specially named pages to create dynamic routes](https://docs.astro.build/en/guides/routing/#dynamic-routes).
- Astro is [component-based](https://docs.astro.build/en/basics/astro-components/), and your markup structure will be similar before and after your migration.
- Astro has [official integrations for React, Preact, and Solid](https://docs.astro.build/en/guides/integrations-guide/react/) so you can use your existing JSX components. Note that in Astro, these files **must** have a `.jsx` or `.tsx` extension.
- Astro has support for [installing NPM packages](https://docs.astro.build/en/guides/imports/#npm-packages), including React libraries. Many of your existing dependencies will work in Astro.

## Key Differences between CRA and Astro

[Section titled ‚ÄúKey Differences between CRA and Astro‚Äù](#key-differences-between-cra-and-astro)

When you rebuild your CRA site in Astro, you will notice some important differences:

- CRA is a single-page application that uses `index.js` as your project‚Äôs root. Astro is a multi-page site, and `index.astro` is your home page.
- [.astrocomponents](https://docs.astro.build/en/basics/astro-components/) are not written as exported functions that return page templating. Instead, you‚Äôll split your code into a ‚Äúcode fence‚Äù for your JavaScript and a body exclusively for the HTML you generate.
- [content-driven](https://docs.astro.build/en/concepts/why-astro/#content-driven): Astro was designed to showcase your content and to allow you to opt-in to interactivity only as needed. An existing CRA app might be built for high client-side interactivity and may require advanced Astro techniques to include items that are more challenging to replicate using `.astro` components, such as dashboards.

## Add your CRA to Astro

[Section titled ‚ÄúAdd your CRA to Astro‚Äù](#add-your-cra-to-astro)

Your existing app can be rendered directly inside a new Astro project, often with no changes to your app‚Äôs code.

### Create a new Astro project

[Section titled ‚ÄúCreate a new Astro project‚Äù](#create-a-new-astro-project)

Use the `create astro` command for your package manager to launch Astro‚Äôs CLI wizard and select a new ‚Äúempty‚Äù Astro project.

- [npm](#tab-panel-3090)
- [pnpm](#tab-panel-3091)
- [Yarn](#tab-panel-3092)

   Terminal window

```
npm create astro@latest
```

   Terminal window

```
pnpm create astro@latest
```

   Terminal window

```
yarn create astro@latest
```

### Add integrations and dependencies

[Section titled ‚ÄúAdd integrations and dependencies‚Äù](#add-integrations-and-dependencies)

Add the React integration using the `astro add` command for your package manager. If your app uses other packages supported by the `astro add` command, like Tailwind and MDX, you can add them all with one command:

- [npm](#tab-panel-3093)
- [pnpm](#tab-panel-3094)
- [Yarn](#tab-panel-3095)

   Terminal window

```
npx astro add reactnpx astro add react tailwind mdx
```

   Terminal window

```
pnpm astro add reactpnpm astro add react tailwind mdx
```

   Terminal window

```
yarn astro add reactyarn astro add react tailwind mdx
```

If your CRA requires any dependencies (e.g. NPM packages), then install them individually using the command line or by adding them to your new Astro project‚Äôs `package.json` manually and then running an install command. Note that many, but not all, React dependencies will work in Astro.

### Add your existing app files

[Section titled ‚ÄúAdd your existing app files‚Äù](#add-your-existing-app-files)

Copy your existing Create React App (CRA) project source files and folders (e.g. `components`, `hooks`, `styles`, etc.) into a new folder inside `src/`, keeping its file structure so your app will continue to work. Note that all `.js` file extensions must be renamed to `.jsx` or `.tsx`.

Do not include any configuration files. You will use Astro‚Äôs own `astro.config.mjs`, `package.json`, and `tsconfig.json`.

Move the contents of your app‚Äôs `public/` folder (e.g. static assets) into Astro‚Äôs `public/` folder.

- Directorypublic/
  - logo.png
  - favicon.ico
  - ‚Ä¶
- Directorysrc/
  - Directorycra-project/
    - App.jsx
    - ‚Ä¶
  - Directorypages/
    - index.astro
- astro.config.mjs
- package.json
- tsconfig.json

### Render your app

[Section titled ‚ÄúRender your app‚Äù](#render-your-app)

Import your app‚Äôs root component in the frontmatter section of `index.astro`, then render the `<App />` component in your page template:

 src/pages/index.astro

```
---import App from '../cra-project/App.jsx';---<App client:load />
```

## Convert your CRA to Astro

[Section titled ‚ÄúConvert your CRA to Astro‚Äù](#convert-your-cra-to-astro)

After [adding your existing app to Astro](#add-your-cra-to-astro), you will probably want to convert your app itself to Astro!

You will replicate a similar component-based design [using Astro HTML templating components for your basic structure](https://docs.astro.build/en/basics/astro-components/) while importing and including individual React components (which may themselves be entire apps!) for islands of interactivity.

Every migration will look different and can be done incrementally without disrupting your working app. Convert individual pieces at your own pace so that more and more of your app is powered by Astro components over time.

As you convert your React app, you will decide which React components you will [rewrite as Astro components](#converting-jsx-files-to-astro-files). Your only restriction is that Astro components can import React components, but React components must only import other React components:

 src/pages/static-components.astro

```
---import MyReactComponent from '../components/MyReactComponent.jsx';---<html>  <body>    <h1>Use React components directly in Astro!</h1>    <MyReactComponent />  </body></html>
```

Instead of importing Astro components into React components, you can nest React components inside a single Astro component:

 src/pages/nested-components.astro

```
---import MyReactSidebar from '../components/MyReactSidebar.jsx';import MyReactButton from '../components/MyReactButton.jsx';---<MyReactSidebar>  <p>Here is a sidebar with some text and a button.</p>  <div slot="actions">    <MyReactButton client:idle />  </div></MyReactSidebar>
```

You may find it helpful to learn about [Astro islands](https://docs.astro.build/en/concepts/islands/) and [Astro components](https://docs.astro.build/en/basics/astro-components/) before restructuring your CRA as an Astro project.

### Compare: JSX vs Astro

[Section titled ‚ÄúCompare: JSX vs Astro‚Äù](#compare-jsx-vs-astro)

Compare the following CRA component and a corresponding Astro component:

- [JSX](#tab-panel-3088)
- [Astro](#tab-panel-3089)

   StarCount.jsx

```
import React, { useState, useEffect } from 'react';import Header from './Header';import Footer from './Footer';
const Component = () => {const [stars, setStars] = useState(0);const [message, setMessage] = useState('');
useEffect(() => {    const fetchData = async () => {        const res = await fetch('https://api.github.com/repos/withastro/astro');        const json = await res.json();
        setStars(json.stargazers_count || 0);        setMessage(json.message);    };
    fetchData();}, []);
return (    <>        <Header />        <p style={{            backgroundColor: `#f4f4f4`,            padding: `1em 1.5em`,            textAlign: `center`,            marginBottom: `1em`        }}>Astro has {stars} üßë‚ÄçüöÄ</p>        <Footer />    </>)};
export default Component;
```

   StarCount.astro

```
---import Header from './Header.astro';import Footer from './Footer.astro';import './layout.css';const res = await fetch('https://api.github.com/repos/withastro/astro')const json = await res.json();const message = json.message;const stars = json.stargazers_count || 0;---<Header /><p class="banner">Astro has {stars} üßë‚ÄçüöÄ</p><Footer /><style>  .banner {    background-color: #f4f4f4;    padding: 1em 1.5em;    text-align: center;    margin-bottom: 1em;  }</style>
```

### Converting JSX files to.astrofiles

[Section titled ‚ÄúConverting JSX files to .astro files‚Äù](#converting-jsx-files-to-astro-files)

Here are some tips for converting a CRA `.js` component into a `.astro` component:

1. Use the returned JSX of the existing CRA component function as the basis for your HTML template.
2. Change any [CRA or JSX syntax to Astro](#reference-convert-cra-syntax-to-astro) or to HTML web standards. This includes `{children}` and `className`, for example.
3. Move any necessary JavaScript, including import statements, into a [‚Äúcode fence‚Äù (---)](https://docs.astro.build/en/basics/astro-components/#the-component-script). Note: JavaScript to [conditionally render content](https://docs.astro.build/en/reference/astro-syntax/#dynamic-html) is often written inside the HTML template directly in Astro.
4. Use [Astro.props](https://docs.astro.build/en/reference/api-reference/#props) to access any additional props that were previously passed to your CRA function.
5. Decide whether any imported components also need to be converted to Astro. You can keep them as React components for now, or forever. But, you may eventually want to convert them to `.astro` components, especially if they do not need to be interactive!
6. Replace `useEffect()` with import statements or [import.meta.glob()](https://docs.astro.build/en/guides/imports/#importmetaglob) to query your local files. Use `fetch()` to fetch external data.

### Migrating Tests

[Section titled ‚ÄúMigrating Tests‚Äù](#migrating-tests)

As Astro outputs raw HTML, it is possible to write end-to-end tests using the output of the build step. Any end-to-end tests written previously might work out-of-the-box if you have been able to match the markup of your CRA site. Testing libraries such as Jest and React Testing Library can be imported and used in Astro to test your React components.

See Astro‚Äôs [testing guide](https://docs.astro.build/en/guides/testing/) for more.

## Reference: Convert CRA Syntax to Astro

[Section titled ‚ÄúReference: Convert CRA Syntax to Astro‚Äù](#reference-convert-cra-syntax-to-astro)

### CRA Imports to Astro

[Section titled ‚ÄúCRA Imports to Astro‚Äù](#cra-imports-to-astro)

Update any [file imports](https://docs.astro.build/en/guides/imports/) to reference relative file paths exactly. This can be done using [import aliases](https://docs.astro.build/en/guides/typescript/#import-aliases), or by writing out a relative path in full.

Note that `.astro` and several other file types must be imported with their full file extension.

 src/pages/authors/Fred.astro

```
---import Card from '../../components/Card.astro';---<Card />
```

### CRA Children Props to Astro

[Section titled ‚ÄúCRA Children Props to Astro‚Äù](#cra-children-props-to-astro)

Convert any instances of `{children}` to an Astro `<slot />`. Astro does not need to receive `{children}` as a function prop and will automatically render child content in a `<slot />`.

 src/components/MyComponent.astro

```
------export default function MyComponent(props) {    return (      <div>        {props.children}      </div>    );}
<div>  <slot /></div>
```

React components that pass multiple sets of children can be migrated to an Astro component using [named slots](https://docs.astro.build/en/basics/astro-components/#named-slots).

See more about [specific<slot />usage in Astro](https://docs.astro.build/en/basics/astro-components/#slots).

### CRA Data Fetching to Astro

[Section titled ‚ÄúCRA Data Fetching to Astro‚Äù](#cra-data-fetching-to-astro)

Fetching data in a Create React App component is similar to Astro, with some slight differences.

You will need to remove any instances of a side effect hook (`useEffect`) for either `import.meta.glob()` or `getCollection()`/`getEntry()` to access data from other files in your project source.

To [fetch remote data](https://docs.astro.build/en/guides/data-fetching/), use `fetch()`.

These data requests are made in the frontmatter of the Astro component and use top-level await.

 src/pages/index.astro

```
---import { getCollection } from 'astro:content';
// Get all `src/content/blog/` entriesconst allBlogPosts = await getCollection('blog');
// Get all `src/pages/posts/` entriesconst allPosts = Object.values(import.meta.glob('../pages/post/*.md', { eager: true }));
// Fetch remote dataconst response = await fetch('https://randomuser.me/api/');const data = await response.json();const randomUser = data.results[0];---
```

See more about local files imports with [import.meta.glob()](https://docs.astro.build/en/guides/imports/#importmetaglob), [querying using the Collections API](https://docs.astro.build/en/guides/content-collections/#querying-collections) or [fetching remote data](https://docs.astro.build/en/guides/data-fetching/).

### CRA Styling to Astro

[Section titled ‚ÄúCRA Styling to Astro‚Äù](#cra-styling-to-astro)

You may need to replace any [CSS-in-JS libraries](https://github.com/withastro/astro/issues/4432) (e.g. styled-components) with other available CSS options in Astro.

If necessary, convert any inline style objects (`style={{ fontWeight: "bold" }}`) to inline HTML style attributes (`style="font-weight:bold;"`). Or, use an [Astro<style>tag](https://docs.astro.build/en/guides/styling/#styling-in-astro) for scoped CSS styles.

 src/components/Card.astro

```
<div style={{backgroundColor: `#f4f4f4`, padding: `1em`}}>{message}</div><div style="background-color: #f4f4f4; padding: 1em;">{message}</div>
```

Tailwind is supported after installing the [Tailwind Vite plugin](https://docs.astro.build/en/guides/styling/#tailwind). No changes to your existing Tailwind code are required!

See more about [Styling in Astro](https://docs.astro.build/en/guides/styling/).

## Troubleshooting

[Section titled ‚ÄúTroubleshooting‚Äù](#troubleshooting)

Your CRA might ‚Äújust work‚Äù in Astro! But, you may likely need to make minor adjustments to duplicate your existing app‚Äôs functionality and/or styles.

If you cannot find your answers within these docs, please visit the [Astro Discord](https://astro.build/chat) and ask questions in our support forum!

## Community Resources

[Section titled ‚ÄúCommunity Resources‚Äù](#community-resources)   [Code Fix: The SIBA Website's Move from Create-React-App to Astro](https://brittanisavery.com/post/move-siba-to-astro)

## More migration guides

- ![](https://docs.astro.build/logos/create-react-app.svg)
  ### Create React App
- ![](https://docs.astro.build/logos/docusaurus.svg)
  ### Docusaurus
- ![](https://docs.astro.build/logos/eleventy.svg)
  ### Eleventy
- ![](https://docs.astro.build/logos/gatsby.svg)
  ### Gatsby
- ![](https://docs.astro.build/logos/gitbook.svg)
  ### GitBook
- ![](https://docs.astro.build/logos/gridsome.svg)
  ### Gridsome
- ![](https://docs.astro.build/logos/hugo.svg)
  ### Hugo
- ![](https://docs.astro.build/logos/jekyll.png)
  ### Jekyll
- ![](https://docs.astro.build/logos/nextjs.svg)
  ### Next.js
- ![](https://docs.astro.build/logos/nuxtjs.svg)
  ### NuxtJS
- ![](https://docs.astro.build/logos/pelican.svg)
  ### Pelican
- ![](https://docs.astro.build/logos/sveltekit.svg)
  ### SvelteKit
- ![](https://docs.astro.build/logos/vuepress.png)
  ### VuePress
- ![](https://docs.astro.build/logos/wordpress.svg)
  ### WordPress

   Recipes     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# Migrating from Docusaurus

> Tips for migrating an existing Docusaurus project to Astro

# Migrating from Docusaurus

[Docusaurus](https://Docusaurus.io) is a popular documentation website builder built on React.

## Key Similarities between Docusaurus and Astro

[Section titled ‚ÄúKey Similarities between Docusaurus and Astro‚Äù](#key-similarities-between-docusaurus-and-astro)

Docusaurus and Astro share some similarities that will help you migrate your project:

- Both Astro and Docusaurus are modern, JavaScript-based (Jamstack) site builders intended for [content-driven websites](https://docs.astro.build/en/concepts/why-astro/#content-driven), like documentation sites.
- Both Astro and Docusaurus support [MDX pages](https://docs.astro.build/en/guides/markdown-content/). You should be able to use your existing `.mdx` files with Astro.
- Both Astro and Docusaurus use [file-based routing](https://docs.astro.build/en/guides/routing/) to generate page routes automatically for any MDX file located in `src/pages`. Using Astro‚Äôs file structure for your existing content and when adding new pages should feel familiar.
- Astro has an [official integration for using React components](https://docs.astro.build/en/guides/integrations-guide/react/). Note that in Astro, React files **must** have a `.jsx` or `.tsx` extension.
- Astro supports [installing NPM packages](https://docs.astro.build/en/guides/imports/#npm-packages), including several for React. You may be able to keep some or all of your existing React components and dependencies.
- [Astro‚Äôs JSX-like syntax](https://docs.astro.build/en/basics/astro-components/#the-component-template) should feel familiar if you are used to writing React.

## Key Differences between Docusaurus and Astro

[Section titled ‚ÄúKey Differences between Docusaurus and Astro‚Äù](#key-differences-between-docusaurus-and-astro)

When you rebuild your Docusaurus site in Astro, you will notice some important differences:

- Docusaurus is a React-based single-page application (SPA). Astro sites are multi-page apps built using [.astrocomponents](https://docs.astro.build/en/basics/astro-components/), but can also support [React, Preact, Vue.js, Svelte, SolidJS, AlpineJS](https://docs.astro.build/en/guides/framework-components/) and raw HTML templating.
- Docusaurus was designed to build documentation websites and has some built-in, documentation-specific website features that you would have to build yourself in Astro. Instead, Astro offers some of these features through [Starlight: an official docs theme](https://starlight.astro.build). This website was the inspiration for Starlight, and now runs on it! You can also find more [community docs themes](https://astro.build/themes?search=&categories%5B%5D=docs) with built-in features in our Themes Showcase.
- Docusaurus sites use MDX pages for content. Astro‚Äôs docs theme uses Markdown (`.md`) files by default and does not require you to use MDX. You can optionally [install Astro‚Äôs MDX integration](https://docs.astro.build/en/guides/integrations-guide/mdx/) (included in our Starlight theme by default) and use `.mdx` files in addition to standard Markdown files.

## Switch from Docusaurus to Astro

[Section titled ‚ÄúSwitch from Docusaurus to Astro‚Äù](#switch-from-docusaurus-to-astro)

To convert a Docusaurus documentation site to Astro, start with our official [Starlight docs theme starter template](https://starlight.astro.build), or explore more community docs themes in our [theme showcase](https://astro.build/themes?search=&categories%5B%5D=docs).

You can pass a `--template` argument to the `create astro` command to start a new Astro project with one of our official starters. Or, you can [start a new project from any existing Astro repository on GitHub](https://docs.astro.build/en/install-and-setup/#install-from-the-cli-wizard).

- [npm](#tab-panel-3096)
- [pnpm](#tab-panel-3097)
- [Yarn](#tab-panel-3098)

   Terminal window

```
npm create astro@latest -- --template starlight
```

   Terminal window

```
pnpm create astro@latest --template starlight
```

   Terminal window

```
yarn create astro --template starlight
```

Astro‚Äôs MDX integration is included by default, so you can [bring your existing content files to Starlight](https://starlight.astro.build/getting-started/#add-content) right away.

You can find Astro‚Äôs docs starter, and other official templates, on [astro.new](https://astro.new). You‚Äôll find a link to each project‚Äôs GitHub repository, as well as one-click links to open a working project in IDX, StackBlitz, CodeSandbox and Gitpod online development environments.

## Community Resources

[Section titled ‚ÄúCommunity Resources‚Äù](#community-resources)   [Speeding up documentation by 10 times (Russian)](https://habr.com/ru/articles/880220/)

## More migration guides

- ![](https://docs.astro.build/logos/create-react-app.svg)
  ### Create React App
- ![](https://docs.astro.build/logos/docusaurus.svg)
  ### Docusaurus
- ![](https://docs.astro.build/logos/eleventy.svg)
  ### Eleventy
- ![](https://docs.astro.build/logos/gatsby.svg)
  ### Gatsby
- ![](https://docs.astro.build/logos/gitbook.svg)
  ### GitBook
- ![](https://docs.astro.build/logos/gridsome.svg)
  ### Gridsome
- ![](https://docs.astro.build/logos/hugo.svg)
  ### Hugo
- ![](https://docs.astro.build/logos/jekyll.png)
  ### Jekyll
- ![](https://docs.astro.build/logos/nextjs.svg)
  ### Next.js
- ![](https://docs.astro.build/logos/nuxtjs.svg)
  ### NuxtJS
- ![](https://docs.astro.build/logos/pelican.svg)
  ### Pelican
- ![](https://docs.astro.build/logos/sveltekit.svg)
  ### SvelteKit
- ![](https://docs.astro.build/logos/vuepress.png)
  ### VuePress
- ![](https://docs.astro.build/logos/wordpress.svg)
  ### WordPress

   Recipes     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

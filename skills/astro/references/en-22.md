# @astrojs/alpinejs and more

# @astrojs/alpinejs

> Learn how to use the @astrojs/alpinejs framework integration to extend component support in your Astro project.

# @astrojs/alpinejs

  v0.4.9 [GitHub](https://github.com/withastro/astro/tree/main/packages/integrations/alpinejs/) [npm](https://www.npmjs.com/package/@astrojs/alpinejs) [Changelog](https://github.com/withastro/astro/tree/main/packages/integrations/alpinejs/CHANGELOG.md)

This **Astro integration** adds [Alpine.js](https://alpinejs.dev/) to your project so that you can use Alpine.js anywhere on your page.

## Installation

[Section titled ‚ÄúInstallation‚Äù](#installation)

Astro includes an `astro add` command to automate the setup of official integrations. If you prefer, you can [install integrations manually](#manual-install) instead.

To install `@astrojs/alpinejs`, run the following from your project directory and follow the prompts:

- [npm](#tab-panel-2932)
- [pnpm](#tab-panel-2933)
- [Yarn](#tab-panel-2934)

   Terminal window

```
npx astro add alpinejs
```

   Terminal window

```
pnpm astro add alpinejs
```

   Terminal window

```
yarn astro add alpinejs
```

If you run into any issues, [feel free to report them to us on GitHub](https://github.com/withastro/astro/issues) and try the manual installation steps below.

### Manual Install

[Section titled ‚ÄúManual Install‚Äù](#manual-install)

First, install the `@astrojs/alpinejs` package.

- [npm](#tab-panel-2935)
- [pnpm](#tab-panel-2936)
- [Yarn](#tab-panel-2937)

   Terminal window

```
npm install @astrojs/alpinejs
```

   Terminal window

```
pnpm add @astrojs/alpinejs
```

   Terminal window

```
yarn add @astrojs/alpinejs
```

Most package managers will install associated peer dependencies as well. However, if you see a `Cannot find package 'alpinejs'` (or similar) warning when you start up Astro, you‚Äôll need to manually install Alpine.js yourself:

- [npm](#tab-panel-2938)
- [pnpm](#tab-panel-2939)
- [Yarn](#tab-panel-2940)

   Terminal window

```
npm install alpinejs @types/alpinejs
```

   Terminal window

```
pnpm add alpinejs @types/alpinejs
```

   Terminal window

```
yarn add alpinejs @types/alpinejs
```

Then, apply the integration to your `astro.config.*` file using the `integrations` property:

 astro.config.mjs

```
import { defineConfig } from 'astro/config';import alpinejs from '@astrojs/alpinejs';
export default defineConfig({  // ...  integrations: [alpinejs()],});
```

## Configuration Options

[Section titled ‚ÄúConfiguration Options‚Äù](#configuration-options)

### entrypoint

[Section titled ‚Äúentrypoint‚Äù](#entrypoint)

**Type:** `string`

 **Added in:** `@astrojs/alpinejs@0.4.0` New

You can extend Alpine by setting the `entrypoint` option to a root-relative import specifier (e.g. `entrypoint: "/src/entrypoint"`).

The default export of this file should be a function that accepts an Alpine instance prior to starting. This allows the use of custom directives, plugins and other customizations for advanced use cases.

 astro.config.mjs

```
import { defineConfig } from 'astro/config';import alpinejs from '@astrojs/alpinejs';
export default defineConfig({  // ...  integrations: [alpinejs({ entrypoint: '/src/entrypoint' })],});
```

 src/entrypoint.ts

```
import type { Alpine } from 'alpinejs'import intersect from '@alpinejs/intersect'
export default (Alpine: Alpine) => {    Alpine.plugin(intersect)}
```

## Usage

[Section titled ‚ÄúUsage‚Äù](#usage)

Once the integration is installed, you can use [Alpine.js](https://alpinejs.dev/) directives and syntax inside any Astro component. The Alpine.js script is automatically added and enabled on every page of your website so no client directives are needed. Add plugin scripts to the page `<head>`.

The following example adds [Alpine‚Äôs Collapse plugin](https://alpinejs.dev/plugins/collapse) to expand and collapse paragraph text:

 src/pages/index.astro

```
------<html>  <head>        <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>  </head>  <body>        <div x-data="{ expanded: false }">      <button @click="expanded = ! expanded">Toggle Content</button>
      <p id="foo" x-show="expanded" x-collapse>        Lorem ipsum      </p>    </div>  </body></html>
```

## Intellisense for TypeScript

[Section titled ‚ÄúIntellisense for TypeScript‚Äù](#intellisense-for-typescript)

The `@astrojs/alpine` integration adds `Alpine` to [the global window object](https://docs.astro.build/en/guides/typescript/#window-and-globalthis). For IDE autocompletion, add the following to your `src/env.d.ts`:

 src/env.d.ts

```
interface Window {  Alpine: import('alpinejs').Alpine;}
```

## Examples

[Section titled ‚ÄúExamples‚Äù](#examples)

- The [Astro Alpine.js example](https://github.com/withastro/astro/tree/main/examples/framework-alpine) shows how to use Alpine.js in an Astro project.

## More integrations

### Front-end frameworks

- ![](https://docs.astro.build/logos/alpine-js.svg)
  ### @astrojs/alpinejs
- ![](https://docs.astro.build/logos/preact.svg)
  ### @astrojs/preact
- ![](https://docs.astro.build/logos/react.svg)
  ### @astrojs/react
- ![](https://docs.astro.build/logos/solid.svg)
  ### @astrojs/solid‚Å†-‚Å†js
- ![](https://docs.astro.build/logos/svelte.svg)
  ### @astrojs/svelte
- ![](https://docs.astro.build/logos/vue.svg)
  ### @astrojs/vue

### Adapters

- ![](https://docs.astro.build/logos/cloudflare-pages.svg)
  ### @astrojs/cloudflare
- ![](https://docs.astro.build/logos/netlify.svg)
  ### @astrojs/netlify
- ![](https://docs.astro.build/logos/node.svg)
  ### @astrojs/node
- ![](https://docs.astro.build/logos/vercel.svg)
  ### @astrojs/vercel

### Other integrations

- ![](https://docs.astro.build/logos/db.svg)
  ### @astrojs/db
- ![](https://docs.astro.build/logos/markdoc.svg)
  ### @astrojs/markdoc
- ![](https://docs.astro.build/logos/mdx.svg)
  ### @astrojs/mdx
- ![](https://docs.astro.build/logos/partytown.svg)
  ### @astrojs/partytown
- ![](https://docs.astro.build/logos/sitemap.svg)
  ### @astrojs/sitemap

  Learn     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# @astrojs/cloudflare

> Learn how to use the @astrojs/cloudflare adapter to deploy your Astro project.

# @astrojs/cloudflare

  v12.6.12 [GitHub](https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/) [npm](https://www.npmjs.com/package/@astrojs/cloudflare) [Changelog](https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/CHANGELOG.md)

This adapter allows Astro to deploy your [on-demand rendered routes and features](https://docs.astro.build/en/guides/on-demand-rendering/) to [Cloudflare](https://www.cloudflare.com/), including [server islands](https://docs.astro.build/en/guides/server-islands/), [actions](https://docs.astro.build/en/guides/actions/), and [sessions](https://docs.astro.build/en/guides/sessions/).

If you‚Äôre using Astro as a static site builder, you don‚Äôt need an adapter.

Learn how to deploy your Astro site in our [Cloudflare deployment guide](https://docs.astro.build/en/guides/deploy/cloudflare/).

## Why Astro Cloudflare

[Section titled ‚ÄúWhy Astro Cloudflare‚Äù](#why-astro-cloudflare)

Cloudflare‚Äôs [Developer Platform](https://developers.cloudflare.com/) lets you develop full-stack applications with access to resources such as storage and AI, all deployed to a global edge network. This adapter builds your Astro project for deployment through Cloudflare.

## Installation

[Section titled ‚ÄúInstallation‚Äù](#installation)

Astro includes an `astro add` command to automate the setup of official integrations. If you prefer, you can [install integrations manually](#manual-install) instead.

Add the Cloudflare adapter to enable server-rendering in your Astro project with the `astro add` command. This will install `@astrojs/cloudflare` and make the appropriate changes to your `astro.config.mjs` file in one step.

- [npm](#tab-panel-2926)
- [pnpm](#tab-panel-2927)
- [Yarn](#tab-panel-2928)

   Terminal window

```
npx astro add cloudflare
```

   Terminal window

```
pnpm astro add cloudflare
```

   Terminal window

```
yarn astro add cloudflare
```

Now, you can enable [on-demand rendering per page](https://docs.astro.build/en/guides/on-demand-rendering/#enabling-on-demand-rendering), or set your build output configuration to `output: 'server'` to [server-render all your pages by default](https://docs.astro.build/en/guides/on-demand-rendering/#server-mode).

### Manual Install

[Section titled ‚ÄúManual Install‚Äù](#manual-install)

1. Add the `@astrojs/cloudflare` adapter to your project‚Äôs dependencies using your preferred package manager.
  - [npm](#tab-panel-2929)
  - [pnpm](#tab-panel-2930)
  - [Yarn](#tab-panel-2931)
     Terminal window
  ```
  npm install @astrojs/cloudflare
  ```
     Terminal window
  ```
  pnpm add @astrojs/cloudflare
  ```
     Terminal window
  ```
  yarn add @astrojs/cloudflare
  ```
2. Add the adapter to your `astro.config.mjs` file:
   astro.config.mjs
  ```
  import { defineConfig } from 'astro/config';import cloudflare from '@astrojs/cloudflare';
  export default defineConfig({  adapter: cloudflare(),});
  ```
3. Create a [Wrangler configuration file](https://developers.cloudflare.com/workers/wrangler/configuration/):
   wrangler.jsonc
  ```
  {  "main": "dist/_worker.js/index.js",  "name": "my-astro-app",  // Update to today's date  "compatibility_date": "2025-03-25",  "compatibility_flags": [    "nodejs_compat",    "global_fetch_strictly_public"  ],  "assets": {    "binding": "ASSETS",    "directory": "./dist"  },  "observability": {    "enabled": true  }}
  ```
4. Create a `.assetsignore` file in your `public/` folder, and add the following lines to it:
   public/.assetsignore
  ```
  _worker.js_routes.json
  ```

## Options

[Section titled ‚ÄúOptions‚Äù](#options)

The Cloudflare adapter accepts the following options:

### cloudflareModules

[Section titled ‚ÄúcloudflareModules‚Äù](#cloudflaremodules)

**Type:** `boolean`
 **Default:** `true`

Enables [imports of.wasm,.bin, and.txtmodules](#cloudflare-module-imports).

This functionality is enabled by default. If you‚Äôd like to disable, set `cloudflareModules` to `false`.

### imageService

[Section titled ‚ÄúimageService‚Äù](#imageservice)

**Type:** `'passthrough' | 'cloudflare' | 'compile' | 'custom'`
 **Default:** `'compile'`

Determines which image service is used by the adapter. The adapter will default to `compile` mode when an incompatible image service is configured. Otherwise, it will use the globally configured image service:

- **cloudflare:** Uses the [Cloudflare Image Resizing](https://developers.cloudflare.com/images/image-resizing/) service.
- **passthrough:** Uses the existing [noop](https://docs.astro.build/en/guides/images/#configure-no-op-passthrough-service) service.
- **compile:** Uses Astro‚Äôs default service (sharp), but only on pre-rendered routes at build time. For pages rendered on-demand, all `astro:assets` features are disabled.
- **custom:** Always uses the image service configured in [Image Options](https://docs.astro.build/en/reference/configuration-reference/#image-options). **This option will not check to see whether the configured image service works in Cloudflare‚Äôsworkerdruntime.**

 astro.config.mjs

```
import { defineConfig } from "astro/config";import cloudflare from '@astrojs/cloudflare';
export default defineConfig({  adapter: cloudflare({     imageService: 'cloudflare'  }),})
```

### platformProxy

[Section titled ‚ÄúplatformProxy‚Äù](#platformproxy)

Determines whether and how the Cloudflare runtime is added to `astro dev`. It contains proxies to local `workerd` bindings and emulations of Cloudflare specific values, allowing the emulation of the runtime in the Node.js dev process. Read more about the [Cloudflare Runtime](#cloudflare-runtime).

#### platformProxy.enabled

[Section titled ‚ÄúplatformProxy.enabled‚Äù](#platformproxyenabled)

**Type:** `boolean`
 **Default:** `true`

Determines whether to enable the Cloudflare runtime in development mode.

#### platformProxy.configPath

[Section titled ‚ÄúplatformProxy.configPath‚Äù](#platformproxyconfigpath)

**Type:** `string`
 **Default:** `undefined`

Defines the path to the Wrangler configuration file. If no value is set, it tracks `wrangler.toml`, `wrangler.json`, and `wrangler.jsonc` in the project root.

#### platformProxy.environment

[Section titled ‚ÄúplatformProxy.environment‚Äù](#platformproxyenvironment)

**Type:** `string`
 **Default:** `undefined`

Sets the [Cloudflare environment](https://developers.cloudflare.com/workers/wrangler/environments/) to use. You must select an environment defined in the Wrangler configuration file, otherwise an error occurs.

#### platformProxy.persist

[Section titled ‚ÄúplatformProxy.persist‚Äù](#platformproxypersist)

**Type:** `boolean | { path: string }`
 **Default:** `true`

Sets whether and where to save binding data locally to the file system.

- If set to `true`, binding data is stored in `.wrangler/state/v3/`. It is the same as the default setting for wrangler.
- If set to `false`, binding data is not stored in file system.
- If set to `{ path: string }`, binding data is stored in the specified path.

The following configuration shows an example of enabling the Cloudflare runtime when running the development server, as well as using a `wrangler.json` config file. It also specifies a custom location for persisting data to the filesystem:

```
import cloudflare from '@astrojs/cloudflare';import { defineConfig } from 'astro/config';
export default defineConfig({  adapter: cloudflare({    platformProxy: {      enabled: true,      configPath: 'wrangler.json',      persist: {        path: './.cache/wrangler/v3'      },    },  }),});
```

### routes.extend

[Section titled ‚Äúroutes.extend‚Äù](#routesextend)

On Cloudflare Workers, this option is not applicable. Refer to [Routing on Cloudflare Workers](#routing-on-cloudflare-workers) for more information.

On Cloudflare Pages, this option allows you to add or exclude custom patterns (e.g. `/fonts/*`) to the generated `_routes.json` file that determines which routes are generated on-demand. This can be useful if you need to add route patterns which cannot be automatically generated, or exclude prerendered routes.

More information about the custom route patterns can be found in [Cloudflare‚Äôs routing docs](https://developers.cloudflare.com/pages/functions/routing/#functions-invocation-routes). Any routes specified are not automatically deduplicated and will be appended to the existing routes as is.

#### routes.extend.include

[Section titled ‚Äúroutes.extend.include‚Äù](#routesextendinclude)

**Type:** `{ pattern: string }[]`
 **Default:** `undefined`

Configures additional routes to be generated on demand by the Cloudflare adapter in the `routes.extend.include` array.

#### routes.extend.exclude

[Section titled ‚Äúroutes.extend.exclude‚Äù](#routesextendexclude)

**Type:** `{ pattern: string }[]`
 **Default:** `undefined`

Configures routes to be excluded from on-demand rendering in the `routes.extend.exclude` array. These routes will be prerendered and served statically instead, and will not invoke the server function. Additionally you can use this option to serve any static asset (e.g. images, fonts, css, js, html, txt, json, etc.) files directly without routing the request through the server function.

 astro.config.mjs

```
export default defineConfig({  adapter: cloudflare({    routes: {      extend: {        include: [{ pattern: '/static' }], // Route a prerended page to the server function for on-demand rendering        exclude: [{ pattern: '/pagefind/*' }], // Use Starlight's pagefind search, which is generated statically at build time      }    },  }),});
```

### sessionKVBindingName

[Section titled ‚ÄúsessionKVBindingName‚Äù](#sessionkvbindingname)

**Type:** `string`
 **Default:** `SESSION`

 **Added in:** `astro@5.6.0`

The `sessionKVBindingName` option allows you to specify the name of the KV binding used for session storage. By default, this is set to `SESSION`, but you can change it to match your own KV binding name. See [Sessions](#sessions) for more information.

 astro.config.mjs

```
export default defineConfig({  adapter: cloudflare({    sessionKVBindingName: 'MY_SESSION_BINDING',  }),});
```

### workerEntryPoint

[Section titled ‚ÄúworkerEntryPoint‚Äù](#workerentrypoint)

**Type:** `{ path: string | URL, namedExports: string[] }`
 **Default:** `{ path: '@astrojs/cloudflare/entrypoints/server.js', namedExports: [] }`

 **Added in:** `@astrojs/cloudflare@12.6.0` New

A configuration object to specify the [workerEntryPoint](https://developers.cloudflare.com/workers/runtime-apis/bindings/service-bindings/rpc/) for your Cloudflare Worker when you use the `astro build` command.

It allows you to optionally specify both a custom file `path` and `namedExports`:

 astro.config.mjs

```
import cloudflare from '@astrojs/cloudflare';import { defineConfig } from 'astro/config';
export default defineConfig({  adapter: cloudflare({    workerEntryPoint: {      path: 'src/worker.ts',      namedExports: ['MyDurableObject']    }  }),});
```

#### workerEntryPoint.path

[Section titled ‚ÄúworkerEntryPoint.path‚Äù](#workerentrypointpath)

**Type:** `string`
 **Default:** `@astrojs/cloudflare/entrypoints/server.js`

 **Added in:** `@astrojs/cloudflare@12.6.0` New

The path to the entry file. This should be a relative path from the root of your Astro project.

By default, the adapter uses a generic entry file, which only supports the `fetch` handler.

To support other [Cloudflare invocation handlers](https://developers.cloudflare.com/workers/observability/logs/workers-logs/#invocation-logs), you can create a custom file to use as the entry point. This is useful if you want to use features that require other handlers (e.g. Durable Objects, Cloudflare Queues, Scheduled Invocations).

#### workerEntryPoint.namedExports

[Section titled ‚ÄúworkerEntryPoint.namedExports‚Äù](#workerentrypointnamedexports)

**Type:** `[]`
 **Default:** `[]`

 **Added in:** `@astrojs/cloudflare@12.6.0` New

An array of named exports to use for the entry file.

Provide any additional defined named exports of your [custom entry file](#creating-a-custom-cloudflare-worker-entry-file) (e.g. `DurableObject`). If not provided, only default exports will be included.

#### Creating a custom Cloudflare Worker entry file

[Section titled ‚ÄúCreating a custom Cloudflare Worker entry file‚Äù](#creating-a-custom-cloudflare-worker-entry-file)

The custom entry file must export the `createExports()` function with a `default` export including all the handlers you need.

The following example entry file registers a Durable Object and a queue handler:

 src/worker.ts

```
import type { SSRManifest } from 'astro';import { App } from 'astro/app';import { handle } from '@astrojs/cloudflare/handler'import { DurableObject } from 'cloudflare:workers';
class MyDurableObject extends DurableObject<Env> {  constructor(ctx: DurableObjectState, env: Env) {    super(ctx, env)  }}
export function createExports(manifest: SSRManifest) {  const app = new App(manifest);  return {    default: {      async fetch(request, env, ctx) {        await env.MY_QUEUE.send("log");        return handle(manifest, app, request, env, ctx);      },      async queue(batch, _env) {        let messages = JSON.stringify(batch.messages);        console.log(`consumed from our queue: ${messages}`);      }    } satisfies ExportedHandler<Env>,    MyDurableObject: MyDurableObject,  }}
```

## Cloudflare runtime

[Section titled ‚ÄúCloudflare runtime‚Äù](#cloudflare-runtime)

### Usage

[Section titled ‚ÄúUsage‚Äù](#usage)

The Cloudflare runtime gives you access to environment variables and bindings to Cloudflare resources defined in your `wrangler.toml`/`wrangler.jsonc` configuration file.

You can access the bindings from `Astro.locals.runtime`:

 src/pages/index.astro

```
---const { env } = Astro.locals.runtime;---
```

You can access the runtime from API endpoints through `context.locals`:

 src/pages/api/someFile.js

```
export function GET(context) {  const runtime = context.locals.runtime;
  return new Response('Some body');}
```

See the [list of all supported bindings](https://developers.cloudflare.com/workers/wrangler/api/#supported-bindings) in the Cloudflare documentation.

### Environment variables and secrets

[Section titled ‚ÄúEnvironment variables and secrets‚Äù](#environment-variables-and-secrets)

The Cloudflare runtime treats environment variables as a type of binding.

For example, you can define an [environment variable](https://developers.cloudflare.com/workers/configuration/environment-variables/#add-environment-variables-via-wrangler) in `wrangler.jsonc` as follows:

 wrangler.jsonc

```
{  "vars" : {    "MY_VARIABLE": "test"  }}
```

Secrets are a special type of environment variable that allow you to attach encrypted text values to your Worker. They need to be defined differently to ensure they are not visible after you set them.

To define `secrets`, add them through the [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/) rather than in your Wrangler config file.

 Terminal window

```
npx wrangler secret put <KEY>
```

To set secrets for local development, you also need to add a `.dev.vars` file to the root of the Astro project:

 .dev.vars

```
DB_PASSWORD=myPassword
```

You can then access environment variables, including secrets, from the `env` object available from `Astro.locals.runtime`:

 src/pages/index.astro

```
---const { env } = Astro.locals.runtime;const myVariable = env.MY_VARIABLE;const secret = env.DB_PASSWORD;---
```

Cloudflare environment variables and secrets are compatible with the [astro:envAPI](https://docs.astro.build/en/guides/environment-variables/#type-safe-environment-variables).

### Typing

[Section titled ‚ÄúTyping‚Äù](#typing)

`wrangler` provides a `types` command to generate TypeScript types for the bindings. This allows you to type locals without the need to manually type them. Refer to the [Cloudflare documentation](https://developers.cloudflare.com/workers/wrangler/commands/#types) for more information.

Every time you change your configuration files (e.g. `wrangler.toml`, `.dev.vars`) you need to run `wrangler types`.

You can type the `runtime` object by [extending global types](https://docs.astro.build/en/guides/typescript/#extending-global-types) using `Runtime`:

 src/env.d.ts

```
type Runtime = import('@astrojs/cloudflare').Runtime<Env>;
declare namespace App {  interface Locals extends Runtime {    otherLocals: {      test: string;    };  }}
```

## Cloudflare Platform

[Section titled ‚ÄúCloudflare Platform‚Äù](#cloudflare-platform)

### Headers

[Section titled ‚ÄúHeaders‚Äù](#headers)

You can attach [custom headers](https://developers.cloudflare.com/pages/platform/headers/) to your responses by adding a `_headers` file in your Astro project‚Äôs `public/` folder. This file will be copied to your build output directory.

This is available on Cloudflare Workers and Pages.

### Assets

[Section titled ‚ÄúAssets‚Äù](#assets)

Assets built by Astro are all named with a hash and therefore can be given long cache headers. By default, Astro on Cloudflare will add such a header for these files.

### Redirects

[Section titled ‚ÄúRedirects‚Äù](#redirects)

You can declare [custom redirects](https://developers.cloudflare.com/pages/platform/redirects/) to redirect requests to a different URL. To do so, add a `_redirects` file in your Astro project‚Äôs `public/` folder. This file will be copied to your build output directory.

This is available on Cloudflare Workers and Pages.

### Routes

[Section titled ‚ÄúRoutes‚Äù](#routes)

#### Routing on Cloudflare Workers

[Section titled ‚ÄúRouting on Cloudflare Workers‚Äù](#routing-on-cloudflare-workers)

Routing for static assets is based on the file structure in the build directory (e.g. `./dist`). If no match is found, this will fall back to the Worker for on-demand rendering. Read more about [static asset routing with Cloudflare Workers](https://developers.cloudflare.com/workers/static-assets/routing/).

Unlike [Cloudflare Pages](#routing-on-cloudflare-pages), with Workers, you do not need a `_routes.json` file.

Currently, the Cloudflare adapter always generates this file. To work around this, create a `.assetsignore` file in your `public/` folder, and add the following lines to it:

 public/.assetsignore

```
_worker.js_routes.json
```

#### Routing on Cloudflare Pages

[Section titled ‚ÄúRouting on Cloudflare Pages‚Äù](#routing-on-cloudflare-pages)

For Cloudflare Pages, [routing](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) uses a `_routes.json` file to determine which requests are routed to the server function and which are served as static assets. By default, a `_routes.json` file will be automatically generated for your project based on its files and configuration.

You can [specify additional routing patterns to follow](#routesextend) in your adapter config, or create your own custom `_routes.json` file to fully override the automatic generation.

Creating a custom `public/_routes.json` will override the automatic generation. See [Cloudflare‚Äôs documentation on creating a custom_routes.json](https://developers.cloudflare.com/pages/platform/functions/routing/#create-a-_routesjson-file) for more details.

## Sessions

[Section titled ‚ÄúSessions‚Äù](#sessions)

The Astro [Sessions API](https://docs.astro.build/en/guides/sessions/) allows you to easily store user data between requests. This can be used for things like user data and preferences, shopping carts, and authentication credentials. Unlike cookie storage, there are no size limits on the data, and it can be restored on different devices.

Astro automatically configures [Workers KV](https://developers.cloudflare.com/kv/) for session storage when using the Cloudflare adapter. Before using sessions, you need to create a KV namespace to store the data and configure a KV binding in your Wrangler config file. By default, Astro expects the KV binding to be named `SESSION`, but you can choose a different name if you prefer by setting the [sessionKVBindingName](#sessionkvbindingname) option in the adapter config.

1. Create a KV namespace using the Wrangler CLI and make note of the ID of the new namespace:
   Terminal window
  ```
  npx wrangler kv namespace create "SESSION"
  ```
2. Declare the KV namespace in your Wrangler config, setting the namespace ID to the one returned by the previous command:
  - [wrangler.jsonc](#tab-panel-2924)
  - [wrangler.toml](#tab-panel-2925)
     wrangler.jsonc
  ```
  {  "kv_namespaces": [    {      "binding": "SESSION",      "id": "<KV_NAMESPACE_ID>"    }  ]}
  ```
    wrangler.toml
  ```
  kv_namespaces = [  { binding = "SESSION", id = "<KV_NAMESPACE_ID>" }]
  ```
3. You can then use sessions in your server code:
   src/components/CartButton.astro
  ```
  ---export const prerender = false;const cart = await Astro.session?.get('cart');---
  <a href="/checkout">üõí {cart?.length ?? 0} items</a>
  ```

## Cloudflare Module Imports

[Section titled ‚ÄúCloudflare Module Imports‚Äù](#cloudflare-module-imports)

The Cloudflare `workerd` runtime supports imports of some [non-standard module types](https://developers.cloudflare.com/workers/wrangler/bundling/#including-non-javascript-modules). Most additional file types are also available in Astro:

- `.wasm` or `.wasm?module`: exports a [WebAssembly.Module](https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Module) that can then be instantiated
- `.bin`: exports an [ArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer) of the raw binary contents of the file
- `.txt`: exports a string of the file contents

All module types export a single default value. Modules can be imported both from server-side rendered pages, or from prerendered pages for static site generation.

The following is an example of importing a Wasm module that then responds to requests by adding the request‚Äôs number parameters together.

 pages/add/[a]/[b].js

```
// Import the WebAssembly moduleimport mod from '../util/add.wasm';
// Instantiate first in order to use itconst addModule: any = new WebAssembly.Instance(mod);
export async function GET(context) {  const a = Number.parseInt(context.params.a);  const b = Number.parseInt(context.params.b);  return new Response(`${addModule.exports.add(a, b)}`);}
```

While this example is trivial, Wasm can be used to accelerate computationally intensive operations which do not involve significant I/O such as embedding an image processing library, or embedding a small pre-indexed database for search over a read-only dataset.

## Node.js compatibility

[Section titled ‚ÄúNode.js compatibility‚Äù](#nodejs-compatibility)

Out of the box, Cloudflare does not support the Node.js runtime APIs. With some configuration, Cloudflare does support a subset of the Node.js runtime APIs. You can find supported Node.js runtime APIs in Cloudflare‚Äôs [documentation](https://developers.cloudflare.com/workers/runtime-apis/nodejs).

To use these APIs, your page or endpoint must be server-side rendered (not pre-rendered) and must use the `import {} from 'node:*'` import syntax.

 pages/api/endpoint.js

```
export const prerender = false;import { Buffer } from 'node:buffer';
```

You‚Äôll also need to modify the `vite` configuration in your Astro config to allow for the `node:*` import syntax:

 astro.config.mjs

```
import {defineConfig} from "astro/config";import cloudflare from '@astrojs/cloudflare';
export default defineConfig({  adapter: cloudflare({}),  vite: {    ssr: {      external: ['node:buffer'],    },  },})
```

Additionally, you‚Äôll need to follow Cloudflare‚Äôs documentation on how to enable support. For detailed guidance, please refer to the [Cloudflare documentation on enabling Node.js compatibility](https://developers.cloudflare.com/workers/runtime-apis/nodejs/).

## Preview with Wrangler

[Section titled ‚ÄúPreview with Wrangler‚Äù](#preview-with-wrangler)

To use [wrangler](https://developers.cloudflare.com/workers/wrangler/) to run your application locally, update the preview script.

For Workers:

 package.json

```
"preview": "wrangler dev"
```

For Pages:

 package.json

```
"preview": "wrangler pages dev ./dist"
```

Developing with [wrangler](https://developers.cloudflare.com/workers/wrangler/) gives you access to [Cloudflare bindings](https://developers.cloudflare.com/pages/platform/functions/bindings), [environment variables](https://developers.cloudflare.com/pages/platform/functions/bindings/#environment-variables), and the [cf object](https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties). Getting hot reloading of the Astro dev server to work with Wrangler might require custom setup. See [community examples](https://github.com/withastro/roadmap/discussions/590).

### Meaningful error messages

[Section titled ‚ÄúMeaningful error messages‚Äù](#meaningful-error-messages)

Currently, errors during running your application in Wrangler are not very useful, due to the minification of your code. For better debugging, you can add `vite.build.minify = false` setting to your `astro.config.mjs`.

 astro.config.mjs

```
export default defineConfig({  adapter: cloudflare(),  vite: {    build: {      minify: false,    },  },});
```

## More integrations

### Front-end frameworks

- ![](https://docs.astro.build/logos/alpine-js.svg)
  ### @astrojs/alpinejs
- ![](https://docs.astro.build/logos/preact.svg)
  ### @astrojs/preact
- ![](https://docs.astro.build/logos/react.svg)
  ### @astrojs/react
- ![](https://docs.astro.build/logos/solid.svg)
  ### @astrojs/solid‚Å†-‚Å†js
- ![](https://docs.astro.build/logos/svelte.svg)
  ### @astrojs/svelte
- ![](https://docs.astro.build/logos/vue.svg)
  ### @astrojs/vue

### Adapters

- ![](https://docs.astro.build/logos/cloudflare-pages.svg)
  ### @astrojs/cloudflare
- ![](https://docs.astro.build/logos/netlify.svg)
  ### @astrojs/netlify
- ![](https://docs.astro.build/logos/node.svg)
  ### @astrojs/node
- ![](https://docs.astro.build/logos/vercel.svg)
  ### @astrojs/vercel

### Other integrations

- ![](https://docs.astro.build/logos/db.svg)
  ### @astrojs/db
- ![](https://docs.astro.build/logos/markdoc.svg)
  ### @astrojs/markdoc
- ![](https://docs.astro.build/logos/mdx.svg)
  ### @astrojs/mdx
- ![](https://docs.astro.build/logos/partytown.svg)
  ### @astrojs/partytown
- ![](https://docs.astro.build/logos/sitemap.svg)
  ### @astrojs/sitemap

  Learn     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)

---

# @astrojs/db

> Learn how to use the @astrojs/db integration in your Astro project.

# @astrojs/db

  v0.19.0 [GitHub](https://github.com/withastro/astro/tree/main/packages/db/) [npm](https://www.npmjs.com/package/@astrojs/db) [Changelog](https://github.com/withastro/astro/tree/main/packages/db/CHANGELOG.md)

Astro DB is a fully-managed SQL database designed for the Astro ecosystem: develop locally in Astro and deploy to any [libSQL-compatible database](https://docs.astro.build/en/guides/astro-db/).

With Astro DB you have a powerful, local, type-safe tool to query and model content as a relational database.

   See the [Astro DB guide](https://docs.astro.build/en/guides/astro-db/) for full usage and examples.

## Installation

[Section titled ‚ÄúInstallation‚Äù](#installation)

Astro includes an `astro add` command to automate the setup of official integrations. If you prefer, you can [install integrations manually](#manual-installation) instead.

Run one of the following commands in a new terminal window.

- [npm](#tab-panel-2918)
- [pnpm](#tab-panel-2919)
- [Yarn](#tab-panel-2920)

   Terminal window

```
npx astro add db
```

   Terminal window

```
pnpm astro add db
```

   Terminal window

```
yarn astro add db
```

#### Manual Installation

[Section titled ‚ÄúManual Installation‚Äù](#manual-installation)

If you prefer to set things up from scratch yourself, skip `astro add` and follow these instructions to install Astro DB yourself.

##### 1. Install the integration from npm via a package manager

[Section titled ‚Äú1. Install the integration from npm via a package manager‚Äù](#1-install-the-integration-from-npm-via-a-package-manager)

- [npm](#tab-panel-2921)
- [pnpm](#tab-panel-2922)
- [Yarn](#tab-panel-2923)

   Terminal window

```
npm install @astrojs/db
```

   Terminal window

```
pnpm add @astrojs/db
```

   Terminal window

```
yarn add @astrojs/db
```

##### 2. Add the integration toastro.config.mjs

[Section titled ‚Äú2. Add the integration to astro.config.mjs‚Äù](#2-add-the-integration-to-astroconfigmjs) astro.config.mjs

```
import { defineConfig } from 'astro/config';import db from '@astrojs/db';
export default defineConfig({  integrations: [   db()  ]});
```

##### 3. Configure your database

[Section titled ‚Äú3. Configure your database‚Äù](#3-configure-your-database)

Create a `db/config.ts` file at the root of your project. This is a special file that Astro will automatically load and use to configure your database tables.

 db/config.ts

```
import { defineDb } from 'astro:db';
export default defineDb({  tables: {},})
```

## Configuration

[Section titled ‚ÄúConfiguration‚Äù](#configuration)

### mode

[Section titled ‚Äúmode‚Äù](#mode)

**Type:** `'node' | 'web'`
 **Default:** `'node'`

 **Added in:** `@astrojs/db@0.18.0`

Configures the driver to use to connect to your database in production.

By default, Astro DB uses a Node.js-based libSQL driver for production deployments. The `node` driver mode is sufficient for most Astro hosted or self-hosted websites with Node.js runtimes. This allows you to connect to your database over several protocols, including `memory:`, `file:`, `ws:`, `wss:`, `libsql`, `http`, and `https`, as well as allowing for more advanced features such as [embedded replicas](https://docs.astro.build/en/guides/astro-db/#syncurl).

When deploying to a serverless environment on a non-Node.js runtime, such as Cloudflare Workers or Deno, a web-based libSQL driver is available. When deploying using the `web` mode, you will be able to make web-based connections over `libsql`, `http`, or `https`.

To use the web libSQL driver mode for non-Node.js environments, set the `mode` property in your adapter‚Äôs configuration:

 astro.config.mjs

```
import { defineConfig } from 'astro/config';import db from '@astrojs/db';
export default defineConfig({  integrations: [   db({     mode: 'web'   })  ]});
```

## Table configuration reference

[Section titled ‚ÄúTable configuration reference‚Äù](#table-configuration-reference)

### columns

[Section titled ‚Äúcolumns‚Äù](#columns)

**Type:** `ColumnsConfig`

Table columns are configured using the `columns` object:

```
import { defineTable, column, NOW } from 'astro:db';
const Comment = defineTable({  columns: {    id: column.number({ primaryKey: true }),    author: column.text(),    content: column.text({ optional: true }),    published: column.date({ default: NOW }),  },});
```

Columns are configured using the `column` utility. `column` supports the following types:

- **column.text(...)** - store either plain or rich text content
- **column.number(...)** - store integer and floating point values
- **column.boolean(...)** - store true / false values
- **column.date(...)** - store `Date` objects, parsed as ISO strings for data storage
- **column.json(...)** - store arbitrary JSON blobs, parsed as stringified JSON for data storage

There are a few shared configuration values across all columns:

- `primaryKey` - Set a `number` or `text` column as the unique identifier.
- `optional` - Astro DB uses `NOT NULL` for all columns by default. Set `optional` to `true` to allow null values.
- `default` - Set the default value for newly inserted entries. This accepts either a static value or a string of `sql` for generated values like timestamps.
- `unique` - Mark a column as unique. This prevents duplicate values across entries in the table.
- `references` - Reference a related table by column. This establishes a foreign key constraint, meaning each column value must have a matching value in the referenced table.

A `text` column can optionally define a list of string literals to serve as an enum for generating types. However, **no runtime validation will be performed**. Removing, adding, and changing values should be handled in your project code.

 db/config.ts

```
import { defineTable, column } from 'astro:db';
// Table definitionconst UserTable = defineTable({  columns: {    id: column.number({ primaryKey: true }),    name: column.text(),    rank: column.text({ enum: ['user', 'mod', 'admin'] }),  },});
// Resulting type definitiontype UserTableInferInsert = {    id?: string;    name: string;    rank: "user" | "mod" | "admin";}
```

### indexes

[Section titled ‚Äúindexes‚Äù](#indexes)

**Type:** `{ on: string | string[]; unique?: boolean | undefined; name?: string | undefined; }[]`

Table indexes are used to improve lookup speeds on a given column or combination of columns. The `indexes` property accepts an array of configuration objects specifying the columns to index:

 db/config.ts

```
import { defineTable, column } from 'astro:db';
const Comment = defineTable({  columns: {    authorId: column.number(),    published: column.date(),    body: column.text(),  },  indexes: [    { on: ["authorId", "published"], unique: true },  ]});
```

This will generate a unique index on the `authorId` and `published` columns with the name `Comment_authorId_published_idx`.

The following configuration options are available for each index:

- `on` - A single column or array of column names to index.
- `unique` (optional) - Set to `true` to enforce unique values across the indexed columns.
- `name` (optional) - A custom name for the unique index. This will override Astro‚Äôs generated name based on the table and column names being indexed (e.g. `Comment_authorId_published_idx`). Custom names are global, so ensure index names do not conflict between tables.

### foreignKeys

[Section titled ‚ÄúforeignKeys‚Äù](#foreignkeys)

**Type:** `{ columns: string | string[]; references: () => Column | Column[]; }[]`

Foreign keys are used to establish a relationship between two tables. The `foreignKeys` property accepts an array of configuration objects that may relate one or more columns between tables:

 db/config.ts

```
import { defineTable, column } from 'astro:db';
const Author = defineTable({  columns: {    firstName: column.text(),    lastName: column.text(),  },});
const Comment = defineTable({  columns: {    authorFirstName: column.text(),    authorLastName: column.text(),    body: column.text(),  },  foreignKeys: [    {      columns: ["authorFirstName", "authorLastName"],      references: () => [Author.columns.firstName, Author.columns.lastName],    },  ],});
```

Each foreign key configuration object accepts the following properties:

- `columns` - A single column or array of column names to relate to the referenced table.
- `references` - A function that returns a single column or an array of columns from the referenced table.

## Astro DB CLI reference

[Section titled ‚ÄúAstro DB CLI reference‚Äù](#astro-db-cli-reference)

Astro DB includes a set of CLI commands to interact with your local and libSQL-compatible database.

These commands are called automatically when using a GitHub CI action, and can be called manually using the `astro db` CLI.

### astro db push

[Section titled ‚Äúastro db push‚Äù](#astro-db-push)

**Flags:**

- `--db-app-token <token>` Provide the remote database app token directly instead of `ASTRO_DB_APP_TOKEN`.
- `--dry-run` Print the generated SQL statements without applying them.
- `--force-reset` Reset all production data if a breaking schema change is required.
- `--remote` Push to your remote database instead of the local database file. Requires the `ASTRO_DB_REMOTE_URL` environment variable to be set, and either `ASTRO_DB_APP_TOKEN` to be set in the environment or a value passed with the `--db-app-token` command-line argument.

Safely push database configuration changes to your project database. This will check for any risk of data loss and guide you on any recommended migration steps. Use `--remote` to apply changes to your remote database. If a breaking schema change must be made, use `--force-reset` to reset all production data.

### astro db verify

[Section titled ‚Äúastro db verify‚Äù](#astro-db-verify)

**Flags:**

- `--db-app-token <token>` Provide the remote database app token directly instead of `ASTRO_DB_APP_TOKEN`.
- `--json` Print a machine-readable JSON result from `verify`.
- `--remote` Compare against your remote database instead of the local database file. Requires the `ASTRO_DB_REMOTE_URL` environment variable to be set, and either `ASTRO_DB_APP_TOKEN` to be set in the environment or a value passed with the `--db-app-token` command-line argument.

Compares your local schema against the remote database to check for any differences between your local and remote database configurations. This is automatically run by `astro db push`.

`verify` will compare your local `db/config.ts` file with the remote database and warn if changes are detected. It will exit with a non-zero code if changes are required or unsafe, making it useful for CI.

### astro db execute <file-path>

[Section titled ‚Äúastro db execute <file-path>‚Äù](#astro-db-execute-file-path)

**Flags:**

- `--db-app-token <token>` Provide the remote database app token directly instead of `ASTRO_DB_APP_TOKEN`.
- `--remote` Run against your libSQL-compatible database. Omit to run against your local database file. Requires the `ASTRO_DB_REMOTE_URL` environment variable to be set, and either `ASTRO_DB_APP_TOKEN` to be set in the environment or a value passed with the `--db-app-token` command-line argument.

Execute a `.ts` or `.js` file to read or write to your database. This accepts a file path as an argument, and supports usage of the `astro:db` module to write type-safe queries. Use the `--remote` flag to run against your libSQL-compatible database, or omit the flag to run against your local database file. See how to [seed development data](https://docs.astro.build/en/guides/astro-db/#seed-your-database-for-development) for an example file.

### astro db shell --query <sql-string>

[Section titled ‚Äúastro db shell --query <sql-string>‚Äù](#astro-db-shell---query-sql-string)

**Flags:**

- `--query` Raw SQL query to execute.
- `--remote` Run against your libSQL-compatible database. Omit to run against your local database file. Requires the `ASTRO_DB_REMOTE_URL` environment variable to be set, and either `ASTRO_DB_APP_TOKEN` to be set in the environment or a value passed with the `--db-app-token` command-line argument.

Execute a raw SQL query against your database.

The following example selects all rows from a `Comment` table in a remote database:

 Terminal window

```
npx astro db shell --query "SELECT * FROM Comment;" --remote
```

## Astro DB utility reference

[Section titled ‚ÄúAstro DB utility reference‚Äù](#astro-db-utility-reference)

### isDbError()

[Section titled ‚ÄúisDbError()‚Äù](#isdberror)

**Type:** `(err: unknown) => boolean`

 **Added in:** `@astrojs/db@0.9.1`

The `isDbError()` function checks if an error is a libSQL database exception. This may include a foreign key constraint error when using references, or missing fields when inserting data. You can combine `isDbError()` with a try / catch block to handle database errors in your application:

 src/pages/api/comment/[id].ts

```
import { db, Comment, isDbError } from 'astro:db';import type { APIRoute } from 'astro';
export const POST: APIRoute = (ctx) => {  try {    await db.insert(Comment).values({      id: ctx.params.id,      content: 'Hello, world!'    });  } catch (e) {    if (isDbError(e)) {      return new Response(`Cannot insert comment with id ${id}\n\n${e.message}`, { status: 400 });    }    return new Response('An unexpected error occurred', { status: 500 });  }
  return new Response(null, { status: 201 });};
```

## More integrations

### Front-end frameworks

- ![](https://docs.astro.build/logos/alpine-js.svg)
  ### @astrojs/alpinejs
- ![](https://docs.astro.build/logos/preact.svg)
  ### @astrojs/preact
- ![](https://docs.astro.build/logos/react.svg)
  ### @astrojs/react
- ![](https://docs.astro.build/logos/solid.svg)
  ### @astrojs/solid‚Å†-‚Å†js
- ![](https://docs.astro.build/logos/svelte.svg)
  ### @astrojs/svelte
- ![](https://docs.astro.build/logos/vue.svg)
  ### @astrojs/vue

### Adapters

- ![](https://docs.astro.build/logos/cloudflare-pages.svg)
  ### @astrojs/cloudflare
- ![](https://docs.astro.build/logos/netlify.svg)
  ### @astrojs/netlify
- ![](https://docs.astro.build/logos/node.svg)
  ### @astrojs/node
- ![](https://docs.astro.build/logos/vercel.svg)
  ### @astrojs/vercel

### Other integrations

- ![](https://docs.astro.build/logos/db.svg)
  ### @astrojs/db
- ![](https://docs.astro.build/logos/markdoc.svg)
  ### @astrojs/markdoc
- ![](https://docs.astro.build/logos/mdx.svg)
  ### @astrojs/mdx
- ![](https://docs.astro.build/logos/partytown.svg)
  ### @astrojs/partytown
- ![](https://docs.astro.build/logos/sitemap.svg)
  ### @astrojs/sitemap

  Learn     [Contribute](https://docs.astro.build/en/contribute/) [Community](https://astro.build/chat) [Sponsor](https://opencollective.com/astrodotbuild)
